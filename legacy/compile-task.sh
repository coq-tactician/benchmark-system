#!/bin/bash

set -eEu
catch() {
    echo "Error $1 occurred on line $2 in $0" >> $GLOBALDIR/error
}
trap 'catch $? $LINENO' ERR

if [ $# -lt 7 ]
then
    echo "Usage: benchmark-supervisor.sh dir global-dir #cpus repo commit packages params bench-params"
    exit 1
fi

DIR=${1}; shift
GLOBALDIR=${1}; shift
CPUS=${1}; shift
REPO=${1}; shift
COMMIT=${1}; shift
PACKAGES=${1}; shift
PARAMS=${1}; shift
BENCHPARAMS=${1}; shift

trap 'rm "$GLOBALDIR"/processors/"$SLURM_JOB_ID"' EXIT

mkdir -p $DIR
COPYDIR=$(mktemp --directory -t tactician-XXXXXX)
COPYDIRBIG=$(hostname):$COPYDIR
echo $COPYDIRBIG > $GLOBALDIR/copy-dir

# Pretend that we are installing in the DIR directory, but we actually do it in COPYDIR
# This is to prevent files generated by local processors to be copied to all nodes
{ time {
      bwrap --dev-bind / / --die-with-parent --bind $COPYDIR $DIR \
            build-initial-opam.sh $DIR $GLOBALDIR $CPUS $REPO $COMMIT "$PACKAGES" "$PARAMS" "$BENCHPARAMS" 2>&3
  }; } 3>&2 2> $GLOBALDIR/base-install-time.log

# Move copy dir
echo "Copy to node head"
NEWCOPYDIR=node-head:$COPYDIR
# Note the training slash
{ time rsync -az $COPYDIR/ $NEWCOPYDIR >/dev/stdout 2>/dev/stderr; } 2>&1

echo $NEWCOPYDIR > $GLOBALDIR/copy-dir

# wait to avoid race conditions
sleep 5m
